name: Digital Humanities Production Deployment

on:
  push:
    branches: ["main"]

jobs:
  deploy-frontend:
    runs-on: [ubuntu]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          echo "Updating package lists..."
          echo "${{ secrets.SERVER_SSH_PASSWORD }}" | sudo -S apt update -y
          echo "Installing necessary packages..."
          echo "${{ secrets.SERVER_SSH_PASSWORD }}" | sudo -S apt install -y nodejs npm

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.18.0"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Install & Build Frontend
        working-directory: /home/dhroot/empire-history-cards/frontend
        run: |
          echo "Installing frontend dependencies..."
          npm install
          export REACT_APP_SERVER_URL=${{ secrets.REACT_APP_SERVER_URL }}
          echo "Building frontend..."
          npm run build
          echo "Frontend build completed."

      - name: Deploy Frontend
        run: |
          echo "Copying frontend files to production directory..."
          sudo cp -r frontend/build/* /var/www/digitalhum
          echo "Frontend deployment completed."

  deploy-backend:
    runs-on: [ubuntu]
    needs: deploy-frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          echo "Ensuring necessary packages are installed..."
          echo "${{ secrets.SERVER_SSH_PASSWORD }}" | sudo -S apt install -y nodejs npm

      - name: Deploy Backend
        run: |
          echo "Navigating to backend directory..."
          cd /home/dhroot/empire-history-cards/server

          echo "Pulling latest code..."
          git pull origin main

          echo "Current commit ID:"
          git rev-parse HEAD

          echo "Loading NVM..."
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

          echo "Installing backend dependencies..."
          npm install

          echo "Building backend..."
          npm run build

          echo "Restarting backend with PM2..."
          SECRET_KEY=${{ secrets.JWT_SECRET_KEY }} pm2 restart dh-api
          pm2 save

          echo "Backend deployment completed."
